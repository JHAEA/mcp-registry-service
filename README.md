# MCP Registry Server

A GitOps-based, read-only MCP (Model Context Protocol) Registry API server. Server definitions are stored in a GitHub repository and managed via pull requests.

## Features

- **Read-only API** — Server definitions managed via GitOps workflow
- **GitHub App authentication** — Secure access to private/public registry repos
- **Disk-based git storage** — Persistent clone with incremental sync
- **LRU caching** — Fixed-size cache for fast server lookups
- **Webhook + polling sync** — Real-time updates via webhook, polling fallback
- **Production-ready** — Prometheus metrics, OpenTelemetry tracing, structured logging
- **Hardened container** — Distroless base, non-root, read-only filesystem

## Quick Start

### Prerequisites

- Go 1.22+
- Docker
- A GitHub App with `contents:read` permission (see [GitHub App Setup](docs/github-app-setup.md))
- A registry data repository (see [Registry Data Format](#registry-data-format))

### Local Development

1. Copy environment file:
   ```bash
   cp deploy/example.env .env
   ```

2. Configure your GitHub App credentials in `.env`

3. Create secrets directory:
   ```bash
   mkdir -p secrets
   # Copy your GitHub App private key
   cp /path/to/your-app.private-key.pem secrets/github-app-key.pem
   ```

4. Start with Docker Compose:
   ```bash
   docker-compose up
   ```

5. Access the API:
   ```bash
   curl http://localhost:8080/v0.1/ping
   curl http://localhost:8080/v0.1/health
   curl http://localhost:8080/v0.1/servers
   ```

### Running Locally (without Docker)

```bash
# Set environment variables
export REGISTRY_REPO_URL=https://github.com/your-org/mcp-servers
export GITHUB_APP_ID=123456
export GITHUB_APP_PRIVATE_KEY_PATH=./secrets/github-app-key.pem
export GITHUB_INSTALLATION_ID=12345678
export WEBHOOK_SECRET=your-webhook-secret
export DATA_PATH=./data

# Run
go run ./cmd/registry
```

## Configuration

| Environment Variable | Required | Default | Description |
|---------------------|----------|---------|-------------|
| `REGISTRY_REPO_URL` | Yes | - | GitHub repository URL for server definitions |
| `REGISTRY_BRANCH` | No | `main` | Branch to track |
| `GITHUB_APP_ID` | Yes | - | GitHub App ID |
| `GITHUB_APP_PRIVATE_KEY` | Yes* | - | Private key content (PEM format) |
| `GITHUB_APP_PRIVATE_KEY_PATH` | Yes* | - | Path to private key file |
| `GITHUB_INSTALLATION_ID` | Yes | - | GitHub App installation ID |
| `WEBHOOK_SECRET` | Yes | - | GitHub webhook secret for signature verification |
| `POLL_INTERVAL` | No | `5m` | Polling interval for sync fallback |
| `CLONE_TIMEOUT` | No | `2m` | Timeout for initial clone operation |
| `DATA_PATH` | No | `/data` | Directory for git clone storage |
| `CACHE_SIZE` | No | `1000` | Maximum servers to cache in memory |
| `PORT` | No | `8080` | HTTP server port |
| `OTLP_ENDPOINT` | No | - | OpenTelemetry collector endpoint |

*One of `GITHUB_APP_PRIVATE_KEY` or `GITHUB_APP_PRIVATE_KEY_PATH` is required.

## API Endpoints

### Server Endpoints

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/v0.1/servers` | List all servers (paginated) |
| `GET` | `/v0.1/servers/{name}` | Get server by name (latest version) |
| `GET` | `/v0.1/servers/{name}/versions` | List versions (returns latest only) |
| `GET` | `/v0.1/servers/{name}/versions/{version}` | Get specific version |

### Utility Endpoints

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/v0.1/health` | Health check with sync status |
| `GET` | `/v0.1/ping` | Simple ping |
| `GET` | `/v0.1/version` | Build version info |
| `GET` | `/metrics` | Prometheus metrics |

### Webhook Endpoint

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/webhooks/github` | GitHub push event webhook |

## Registry Data Format

The registry data repository must have this structure:

```
your-registry-repo/
├── index.yaml          # Required: Server index (generated by CI)
└── servers/
    ├── io.github.user--server-a.yaml
    ├── io.github.user--server-b.yaml
    └── com.example--my-server.yaml
```

### index.yaml

```yaml
version: "2025-01-13T00:00:00Z"
commit: "abc123def456"
updated_at: "2025-01-13T12:00:00Z"
servers:
  - name: io.github.user/server-a
    path: servers/io.github.user--server-a.yaml
    description: My awesome MCP server
    version: "1.0.0"
```

### Server Definition

```yaml
$schema: https://static.modelcontextprotocol.io/schemas/2025-12-11/server.schema.json
name: io.github.user/server-a
description: My awesome MCP server
version: "1.0.0"
repository:
  url: https://github.com/user/server-a
  source: github
packages:
  - registryType: npm
    identifier: "@user/server-a"
    version: "1.0.0"
    transport:
      type: stdio
```

## Security

### Container Hardening

- **Distroless base image** — Minimal attack surface, no shell
- **Non-root user** — Runs as UID 65532
- **Read-only filesystem** — Only `/data` is writable
- **Dropped capabilities** — All Linux capabilities dropped
- **No privilege escalation** — `no-new-privileges` security option

### Network Security

- **HMAC-SHA256 webhook verification** — Validates GitHub signatures
- **GitHub App authentication** — Tokens auto-refresh before expiry
- **TLS required** — Use a reverse proxy for TLS termination

## Observability

### Prometheus Metrics

- `http_requests_total` — Request count by method, path, status
- `http_request_duration_seconds` — Request latency histogram
- `registry_sync_duration_seconds` — Sync operation duration
- `registry_sync_errors_total` — Sync error count
- `registry_cache_hits_total` — Cache hit count
- `registry_cache_misses_total` — Cache miss count
- `registry_servers_total` — Total servers in registry

### OpenTelemetry Tracing

Set `OTLP_ENDPOINT` to enable distributed tracing. Traces include:
- HTTP request spans with attributes
- Git operation spans
- Cache operation spans

### Structured Logging

JSON-formatted logs with:
- Request ID correlation
- Repository URL and commit SHA
- Error details with stack context

## Development

### Build

```bash
go build -o registry ./cmd/registry
```

### Test

```bash
go test -v -race ./...
```

### Lint

```bash
golangci-lint run
```

### Docker Build

```bash
docker build -t mcp-registry:dev \
  --build-arg VERSION=dev \
  --build-arg GIT_COMMIT=$(git rev-parse HEAD) \
  --build-arg BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
  .
```

## License

Apache 2.0
